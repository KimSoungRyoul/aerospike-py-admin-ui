from __future__ import annotations

import asyncio
import logging

from aerospike_py.exception import AdminError, AerospikeError
from fastapi import APIRouter, HTTPException, Query

from aerospike_py_admin_ui_api.constants import EE_MSG
from aerospike_py_admin_ui_api.dependencies import AerospikeClient
from aerospike_py_admin_ui_api.models.admin import AerospikeRole, CreateRoleRequest, Privilege

logger = logging.getLogger(__name__)

router = APIRouter(prefix="/api/admin", tags=["admin-roles"])


def _query_roles_sync(c) -> list[AerospikeRole]:
    raw_roles = c.admin_query_roles()
    roles: list[AerospikeRole] = []
    for info in raw_roles:
        privs_raw = info.get("privileges", [])
        privileges: list[Privilege] = []
        for p in privs_raw:
            if isinstance(p, dict):
                privileges.append(
                    Privilege(
                        code=p.get("code", ""),
                        namespace=p.get("ns") or p.get("namespace"),
                        set=p.get("set"),
                    )
                )
            else:
                privileges.append(Privilege(code=str(p)))

        roles.append(
            AerospikeRole(
                name=info.get("role", ""),
                privileges=privileges,
                whitelist=info.get("whitelist", []),
                readQuota=info.get("read_quota", 0),
                writeQuota=info.get("write_quota", 0),
            )
        )
    return roles


@router.get(
    "/{conn_id}/roles",
    summary="List roles",
    description="Retrieve all Aerospike roles and their privileges. Requires Enterprise Edition.",
)
async def get_roles(client: AerospikeClient) -> list[AerospikeRole]:
    """Retrieve all Aerospike roles and their privileges. Requires Enterprise Edition."""
    try:
        return await asyncio.to_thread(_query_roles_sync, client)
    except AdminError:
        raise HTTPException(status_code=403, detail=EE_MSG) from None
    except AerospikeError as e:
        if "security" in str(e).lower() or "not enabled" in str(e).lower() or "not supported" in str(e).lower():
            raise HTTPException(status_code=403, detail=EE_MSG) from None
        raise


def _create_role_sync(c, body: CreateRoleRequest) -> None:
    privileges = [{"code": p.code, "ns": p.namespace or "", "set": p.set or ""} for p in body.privileges]
    c.admin_create_role(
        body.name,
        privileges,
        whitelist=body.whitelist or [],
        read_quota=body.readQuota or 0,
        write_quota=body.writeQuota or 0,
    )


@router.post(
    "/{conn_id}/roles",
    status_code=201,
    summary="Create role",
    description="Create a new Aerospike role with specified privileges. Requires Enterprise Edition.",
)
async def create_role(body: CreateRoleRequest, client: AerospikeClient) -> AerospikeRole:
    """Create a new Aerospike role with specified privileges. Requires Enterprise Edition."""
    if not body.name or not body.privileges:
        raise HTTPException(status_code=400, detail="Missing required fields: name, privileges")

    try:
        await asyncio.to_thread(_create_role_sync, client, body)
    except AdminError:
        raise HTTPException(status_code=403, detail=EE_MSG) from None

    return AerospikeRole(
        name=body.name,
        privileges=body.privileges,
        whitelist=body.whitelist or [],
        readQuota=body.readQuota or 0,
        writeQuota=body.writeQuota or 0,
    )


def _drop_role_sync(c, name: str) -> None:
    c.admin_drop_role(name)


@router.delete(
    "/{conn_id}/roles",
    summary="Delete role",
    description="Delete an Aerospike role by name. Requires Enterprise Edition.",
)
async def delete_role(
    client: AerospikeClient,
    name: str = Query(..., min_length=1),
) -> dict:
    """Delete an Aerospike role by name. Requires Enterprise Edition."""
    try:
        await asyncio.to_thread(_drop_role_sync, client, name)
    except AdminError:
        raise HTTPException(status_code=403, detail=EE_MSG) from None

    return {"message": "Role deleted"}

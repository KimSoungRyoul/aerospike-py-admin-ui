services:
  # ── Aerospike 3-Node Mesh Cluster ──────────────────────────────────
  aerospike-node-1:
    container_name: aerospike-node-1
    image: aerospike:ce-8.1.0.3_1
    command: ["--config-file", "/opt/aerospike/etc/aerospike.conf"]
    volumes:
      - ./aerospike/aerospike.conf:/opt/aerospike/etc/aerospike.conf:ro
    healthcheck:
      test: ["CMD", "asinfo", "-v", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  aerospike-node-2:
    container_name: aerospike-node-2
    image: aerospike:ce-8.1.0.3_1
    command: ["--config-file", "/opt/aerospike/etc/aerospike.conf"]
    volumes:
      - ./aerospike/aerospike.conf:/opt/aerospike/etc/aerospike.conf:ro
    healthcheck:
      test: ["CMD", "asinfo", "-v", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  aerospike-node-3:
    container_name: aerospike-node-3
    image: aerospike:ce-8.1.0.3_1
    command: ["--config-file", "/opt/aerospike/etc/aerospike.conf"]
    volumes:
      - ./aerospike/aerospike.conf:/opt/aerospike/etc/aerospike.conf:ro
    healthcheck:
      test: ["CMD", "asinfo", "-v", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # ── Aerospike Tools (stays alive for `podman exec -it`) ─────────────
  aerospike-tools:
    container_name: aerospike-tools
    image: aerospike/aerospike-tools:8.1
    entrypoint: []
    command: ["tail", "-f", "/dev/null"]
    depends_on:
      aerospike-node-1:
        condition: service_healthy
    stdin_open: true
    tty: true
    restart: unless-stopped

  # ── Seed Data (runs once: 1234 records + indexes + UDFs) ───────────
  aerospike-seed:
    container_name: aerospike-seed
    image: aerospike/aerospike-tools:8.1
    entrypoint: []
    volumes:
      - ./aerospike/seed-data.sh:/seed-data.sh:ro
      - ./aerospike/lua:/lua:ro
    command: ["/usr/bin/bash", "/seed-data.sh"]
    environment:
      - AEROSPIKE_HOST=aerospike-node-1
      - AEROSPIKE_PORT=3000
    depends_on:
      aerospike-node-1:
        condition: service_healthy
      aerospike-node-2:
        condition: service_healthy
      aerospike-node-3:
        condition: service_healthy
    restart: "no"

  # ── Prometheus Exporters (per node) ────────────────────────────────
  aerospike-exporter-1:
    container_name: aerospike-exporter-1
    image: aerospike/aerospike-prometheus-exporter:v1.15.0
    environment:
      - AS_HOST=aerospike-node-1
      - AS_PORT=3000
    ports:
      - "9145:9145"
    depends_on:
      aerospike-node-1:
        condition: service_healthy
    restart: unless-stopped

  aerospike-exporter-2:
    container_name: aerospike-exporter-2
    image: aerospike/aerospike-prometheus-exporter:v1.15.0
    environment:
      - AS_HOST=aerospike-node-2
      - AS_PORT=3000
    ports:
      - "9146:9145"
    depends_on:
      aerospike-node-2:
        condition: service_healthy
    restart: unless-stopped

  aerospike-exporter-3:
    container_name: aerospike-exporter-3
    image: aerospike/aerospike-prometheus-exporter:v1.15.0
    environment:
      - AS_HOST=aerospike-node-3
      - AS_PORT=3000
    ports:
      - "9147:9145"
    depends_on:
      aerospike-node-3:
        condition: service_healthy
    restart: unless-stopped

  # ── PostgreSQL ───────────────────────────────────────────────────────
  postgres:
    container_name: postgres
    image: postgres:17-alpine
    environment:
      POSTGRES_USER: aerospike
      POSTGRES_PASSWORD: aerospike
      POSTGRES_DB: aerospike_manager
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U aerospike -d aerospike_manager"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped

  # ── Backend ────────────────────────────────────────────────────────
  aerospike-cluster-manager-backend:
    container_name: aerospike-cluster-manager-backend
    build: ./backend
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    environment:
      - CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3100}
      - HOST=0.0.0.0
      - PORT=8000
      - AEROSPIKE_HOST=${AEROSPIKE_HOST:-aerospike-node-1}
      - AEROSPIKE_PORT=${AEROSPIKE_PORT:-3000}
      - DATABASE_URL=postgresql://aerospike:aerospike@postgres:5432/aerospike_manager
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    depends_on:
      postgres:
        condition: service_healthy
      aerospike-node-1:
        condition: service_healthy
      aerospike-node-2:
        condition: service_healthy
      aerospike-node-3:
        condition: service_healthy
    restart: unless-stopped

  # ── Frontend ───────────────────────────────────────────────────────
  aerospike-cluster-manager-frontend:
    container_name: aerospike-cluster-manager-frontend
    build:
      context: ./frontend
      args:
        BACKEND_URL: http://aerospike-cluster-manager-backend:8000
    ports:
      - "${FRONTEND_PORT:-3100}:3000"
    environment:
      - BACKEND_URL=http://aerospike-cluster-manager-backend:8000
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3000/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    depends_on:
      aerospike-cluster-manager-backend:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres-data:

"use client";

import { use, useEffect, useState, useMemo, useCallback } from "react";
import { useRouter } from "next/navigation";
import { Plus, Eye, Pencil, Trash2, Copy, Database, Code, Check, Minus, X } from "lucide-react";
import type { ColumnDef, ColumnPinningState } from "@tanstack/react-table";
import { Button } from "@/components/ui/button";
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from "@/components/ui/tooltip";
import { ConfirmDialog } from "@/components/common/confirm-dialog";
import { DataTable } from "@/components/common/data-table";
import { InlineAlert } from "@/components/common/inline-alert";
import { TablePagination } from "@/components/common/table-pagination";
import { renderCellValue } from "@/components/browser/record-cell-renderer";
import { RecordViewDialog } from "@/components/browser/record-view-dialog";
import {
  RecordEditorDialog,
  type BinEntry,
  parseBinValue,
  detectBinType,
  serializeBinValue,
} from "@/components/browser/record-editor-dialog";
import { BatchReadDialog } from "@/components/browser/batch-read-dialog";
import { useBrowserStore } from "@/stores/browser-store";
import { useConnectionStore } from "@/stores/connection-store";
import { usePagination } from "@/hooks/use-pagination";
import type { AerospikeRecord, BinValue, RecordWriteRequest } from "@/lib/api/types";
import { PAGE_SIZE_OPTIONS } from "@/lib/constants";
import { cn, getErrorMessage } from "@/lib/utils";
import { truncateMiddle, formatNumber } from "@/lib/formatters";
import { useBreakpoint } from "@/hooks/use-breakpoint";
import { toast } from "sonner";

const COLUMN_PINNING: ColumnPinningState = {
  left: ["select", "rowNumber"],
  right: ["actions"],
};

/* ─── Page Component ─────────────────────────────────── */

export default function BrowserPage({
  params,
}: {
  params: Promise<{ connId: string; ns: string; set: string }>;
}) {
  const { connId, ns, set } = use(params);
  const router = useRouter();

  const {
    records,
    total,
    page,
    pageSize,
    loading,
    error,
    fetchRecords,
    putRecord,
    deleteRecord,
    setPage,
    setPageSize,
  } = useBrowserStore();

  const pagination = usePagination({ total, page, pageSize });

  const connections = useConnectionStore((s) => s.connections);
  const currentConnection = useMemo(
    () => connections.find((c) => c.id === connId),
    [connections, connId],
  );

  const [selectedPKs, setSelectedPKs] = useState<Set<string>>(new Set());
  const [batchDialogOpen, setBatchDialogOpen] = useState(false);

  const [viewRecord, setViewRecord] = useState<AerospikeRecord | null>(null);
  const [editorOpen, setEditorOpen] = useState(false);
  const [editorMode, setEditorMode] = useState<"create" | "edit" | "duplicate">("create");
  const [deleteTarget, setDeleteTarget] = useState<AerospikeRecord | null>(null);
  const [deleting, setDeleting] = useState(false);
  const [saving, setSaving] = useState(false);

  // Editor form state
  const [editorPK, setEditorPK] = useState("");
  const [editorTTL, setEditorTTL] = useState("0");
  const [editorBins, setEditorBins] = useState<BinEntry[]>([
    { id: crypto.randomUUID(), name: "", value: "", type: "string" },
  ]);
  const [useCodeEditor, setUseCodeEditor] = useState<Record<string, boolean>>({});

  useEffect(() => {
    fetchRecords(connId, decodeURIComponent(ns), decodeURIComponent(set));
  }, [connId, ns, set, fetchRecords]);

  const decodedNs = decodeURIComponent(ns);
  const decodedSet = decodeURIComponent(set);

  // Detect dynamic bin columns from records
  const binColumns = useMemo(() => {
    const allBins = new Set<string>();
    records.forEach((r) => {
      Object.keys(r.bins).forEach((b) => allBins.add(b));
    });
    return Array.from(allBins).sort();
  }, [records]);

  const openEditor = useCallback(
    (mode: "create" | "edit" | "duplicate", record?: AerospikeRecord) => {
      setEditorMode(mode);
      if (record && (mode === "edit" || mode === "duplicate")) {
        setEditorPK(mode === "duplicate" ? "" : record.key.pk);
        setEditorTTL(String(record.meta.ttl));
        setEditorBins(
          Object.entries(record.bins).map(([name, value]) => ({
            id: crypto.randomUUID(),
            name,
            value: serializeBinValue(value),
            type: detectBinType(value),
          })),
        );
      } else {
        setEditorPK("");
        setEditorTTL("0");
        setEditorBins([{ id: crypto.randomUUID(), name: "", value: "", type: "string" }]);
      }
      setUseCodeEditor({});
      setEditorOpen(true);
    },
    [],
  );

  const addBin = useCallback(() => {
    setEditorBins((prev) => [
      ...prev,
      { id: crypto.randomUUID(), name: "", value: "", type: "string" },
    ]);
  }, []);

  const removeBin = useCallback((id: string) => {
    setEditorBins((prev) => prev.filter((b) => b.id !== id));
  }, []);

  const updateBin = useCallback((id: string, field: keyof BinEntry, val: string) => {
    setEditorBins((prev) => prev.map((b) => (b.id === id ? { ...b, [field]: val } : b)));
  }, []);

  const handleSaveRecord = async () => {
    if (!editorPK.trim()) {
      toast.error("Primary key is required");
      return;
    }
    setSaving(true);
    try {
      const bins: Record<string, BinValue> = {};
      for (const bin of editorBins) {
        if (bin.name.trim()) {
          bins[bin.name.trim()] = parseBinValue(bin.value, bin.type);
        }
      }
      const data: RecordWriteRequest = {
        key: { namespace: decodedNs, set: decodedSet, pk: editorPK.trim() },
        bins,
        ttl: parseInt(editorTTL, 10) || 0,
      };
      await putRecord(connId, data);
      toast.success(
        editorMode === "create"
          ? "Record created"
          : editorMode === "duplicate"
            ? "Record duplicated"
            : "Record updated",
      );
      setEditorOpen(false);
    } catch (err) {
      toast.error(getErrorMessage(err));
    } finally {
      setSaving(false);
    }
  };

  const handleDeleteRecord = async () => {
    if (!deleteTarget) return;
    setDeleting(true);
    try {
      await deleteRecord(
        connId,
        deleteTarget.key.namespace,
        deleteTarget.key.set,
        deleteTarget.key.pk,
      );
      toast.success("Record deleted");
      setDeleteTarget(null);
    } catch (err) {
      toast.error(getErrorMessage(err));
    } finally {
      setDeleting(false);
    }
  };

  const handlePageChange = useCallback(
    (newPage: number) => {
      setPage(newPage);
      fetchRecords(connId, decodedNs, decodedSet, newPage);
    },
    [connId, decodedNs, decodedSet, setPage, fetchRecords],
  );

  const handlePageSizeChange = useCallback(
    (newSize: number) => {
      setPageSize(newSize);
      fetchRecords(connId, decodedNs, decodedSet, 1, newSize);
    },
    [connId, decodedNs, decodedSet, setPageSize, fetchRecords],
  );

  const togglePK = useCallback((pk: string) => {
    setSelectedPKs((prev) => {
      const next = new Set(prev);
      if (next.has(pk)) next.delete(pk);
      else next.add(pk);
      return next;
    });
  }, []);

  const toggleAllPKs = useCallback(() => {
    setSelectedPKs((prev) => {
      if (prev.size === records.length) return new Set();
      return new Set(records.map((r) => String(r.key.pk)));
    });
  }, [records]);

  const generateBatchReadCode = useCallback(() => {
    const selected = records.filter((r) => selectedPKs.has(String(r.key.pk)));
    const host = currentConnection?.hosts?.[0] ?? "127.0.0.1";
    const port = currentConnection?.port ?? 3000;
    const keysStr = selected
      .map((r) => `    ("${decodedNs}", "${decodedSet}", "${r.key.pk}")`)
      .join(",\n");

    return `import aerospike
from aerospike_helpers.batch import records as br

keys = [
${keysStr},
]

client = aerospike.client({"hosts": [("${host}", ${port})]}).connect()
batch_results = client.batch_read(keys)

for result in batch_results:
    print(result.key, result.bins)`;
  }, [records, selectedPKs, decodedNs, decodedSet, currentConnection]);

  const padLength = String(pagination.end).length;
  const { isDesktop } = useBreakpoint();

  /* ─── DataTable column definitions ─────────────────── */

  const tableMinWidth = useMemo(
    () => 40 + 56 + 180 + 70 + 80 + binColumns.length * 160 + 130,
    [binColumns.length],
  );

  const tableColumns = useMemo<ColumnDef<AerospikeRecord, unknown>[]>(
    () => [
      // Checkbox (pinned left)
      {
        id: "select",
        size: 40,
        header: () => (
          <button
            onClick={toggleAllPKs}
            className={cn(
              "inline-flex h-4 w-4 items-center justify-center rounded border transition-colors",
              selectedPKs.size === records.length && records.length > 0
                ? "border-accent bg-accent text-accent-foreground"
                : selectedPKs.size > 0
                  ? "border-accent/60 bg-accent/20"
                  : "border-muted-foreground/30 hover:border-muted-foreground/50",
            )}
          >
            {selectedPKs.size === records.length && records.length > 0 ? (
              <Check className="h-3 w-3" />
            ) : selectedPKs.size > 0 ? (
              <Minus className="h-3 w-3" />
            ) : null}
          </button>
        ),
        cell: ({ row }) => (
          <button
            onClick={(e) => {
              e.stopPropagation();
              togglePK(String(row.original.key.pk));
            }}
            className={cn(
              "inline-flex h-4 w-4 items-center justify-center rounded border transition-colors",
              selectedPKs.has(String(row.original.key.pk))
                ? "border-accent bg-accent text-accent-foreground"
                : "border-muted-foreground/30 hover:border-muted-foreground/50",
            )}
          >
            {selectedPKs.has(String(row.original.key.pk)) && <Check className="h-3 w-3" />}
          </button>
        ),
        meta: { className: "px-2 text-center" },
      },
      // Row number (pinned left)
      {
        id: "rowNumber",
        size: 56,
        header: () => <span className="grid-row-num font-mono">#</span>,
        cell: ({ row }) => (
          <span className="grid-row-num font-mono">
            {String(pagination.start + row.index).padStart(padLength, "0")}
          </span>
        ),
        meta: { className: "px-4 text-right" },
      },
      // PK
      {
        id: "pk",
        size: 180,
        header: () => (
          <span className="text-muted-foreground/60 font-mono text-[10px] font-semibold tracking-[0.1em] uppercase">
            PK
          </span>
        ),
        cell: ({ row }) => (
          <span className="text-foreground truncate font-mono text-[13px] font-medium">
            {truncateMiddle(String(row.original.key.pk), 28)}
          </span>
        ),
        meta: { className: "overflow-hidden" },
      },
      // Generation
      {
        id: "gen",
        size: 70,
        header: () => (
          <span className="text-muted-foreground/60 font-mono text-[10px] font-semibold tracking-[0.1em] uppercase">
            Gen
          </span>
        ),
        cell: ({ row }) => (
          <span className="text-muted-foreground font-mono text-xs tabular-nums">
            {row.original.meta.generation}
          </span>
        ),
      },
      // TTL
      {
        id: "ttl",
        size: 80,
        header: () => (
          <span className="text-muted-foreground/60 font-mono text-[10px] font-semibold tracking-[0.1em] uppercase">
            TTL
          </span>
        ),
        cell: ({ row }) => {
          const ttl = row.original.meta.ttl;
          return (
            <span className="text-muted-foreground/60 font-mono text-xs">
              {ttl === -1 ? "∞" : ttl === 0 ? "—" : `${ttl}s`}
            </span>
          );
        },
      },
      // Dynamic bin columns
      ...binColumns.map(
        (col): ColumnDef<AerospikeRecord, unknown> => ({
          id: `bin_${col}`,
          size: 160,
          header: () => (
            <span className="text-muted-foreground/60 font-mono text-[10px] font-semibold tracking-[0.1em]">
              {col}
            </span>
          ),
          cell: ({ row }) => renderCellValue(row.original.bins[col]),
          meta: { className: "overflow-hidden" },
        }),
      ),
      // Actions (pinned right)
      {
        id: "actions",
        size: 130,
        header: () => null,
        cell: ({ row }) => (
          <div className="row-actions-group flex items-center justify-end gap-0.5">
            <Tooltip>
              <TooltipTrigger asChild>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setViewRecord(row.original);
                  }}
                  className="text-muted-foreground hover:text-foreground hover:bg-muted/50 inline-flex h-7 w-7 items-center justify-center rounded-md transition-colors"
                >
                  <Eye className="h-3.5 w-3.5" />
                </button>
              </TooltipTrigger>
              <TooltipContent side="bottom">
                <span className="font-mono text-[10px]">View</span>
              </TooltipContent>
            </Tooltip>

            <Tooltip>
              <TooltipTrigger asChild>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    openEditor("edit", row.original);
                  }}
                  className="text-muted-foreground hover:text-foreground hover:bg-muted/50 inline-flex h-7 w-7 items-center justify-center rounded-md transition-colors"
                >
                  <Pencil className="h-3.5 w-3.5" />
                </button>
              </TooltipTrigger>
              <TooltipContent side="bottom">
                <span className="font-mono text-[10px]">Edit</span>
              </TooltipContent>
            </Tooltip>

            <Tooltip>
              <TooltipTrigger asChild>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    openEditor("duplicate", row.original);
                  }}
                  className="text-muted-foreground hover:text-foreground hover:bg-muted/50 inline-flex h-7 w-7 items-center justify-center rounded-md transition-colors"
                >
                  <Copy className="h-3.5 w-3.5" />
                </button>
              </TooltipTrigger>
              <TooltipContent side="bottom">
                <span className="font-mono text-[10px]">Duplicate</span>
              </TooltipContent>
            </Tooltip>

            <Tooltip>
              <TooltipTrigger asChild>
                <button
                  onClick={(e) => {
                    e.stopPropagation();
                    setDeleteTarget(row.original);
                  }}
                  className="text-muted-foreground hover:text-destructive hover:bg-destructive/10 inline-flex h-7 w-7 items-center justify-center rounded-md transition-colors"
                >
                  <Trash2 className="h-3.5 w-3.5" />
                </button>
              </TooltipTrigger>
              <TooltipContent side="bottom">
                <span className="font-mono text-[10px]">Delete</span>
              </TooltipContent>
            </Tooltip>
          </div>
        ),
      },
    ],
    // eslint-disable-next-line react-hooks/exhaustive-deps
    [binColumns, selectedPKs, records.length, toggleAllPKs, togglePK, pagination.start, padLength],
  );

  /* ─── Render ───────────────────────────────────────── */

  return (
    <div className="flex h-full flex-col">
      {/* ── Command Bar ──────────────────────────────── */}
      <div className="border-border/50 bg-card/80 border-b px-3 py-2.5 backdrop-blur-md sm:px-6">
        <div className="flex items-center justify-between gap-2">
          <div className="flex min-w-0 items-center gap-2 sm:gap-4">
            <nav className="flex min-w-0 items-center gap-0.5 font-mono text-[13px]">
              <button
                onClick={() => router.push(`/browser/${connId}`)}
                className="text-muted-foreground hover:text-foreground shrink-0 transition-colors"
              >
                Namespaces
              </button>
              <span className="text-muted-foreground/30 mx-1 shrink-0 sm:mx-1.5">›</span>
              <button
                onClick={() => router.push(`/browser/${connId}`)}
                className="text-muted-foreground hover:text-foreground max-w-[60px] truncate transition-colors sm:max-w-none"
              >
                {decodedNs}
              </button>
              <span className="text-muted-foreground/30 mx-1 shrink-0 sm:mx-1.5">›</span>
              <span className="text-accent max-w-[80px] truncate font-medium sm:max-w-none">
                {decodedSet}
              </span>
            </nav>

            {total > 0 && (
              <div className="bg-accent/8 border-accent/15 flex shrink-0 items-center gap-1.5 rounded-full border px-2.5 py-0.5">
                <span className="relative flex h-1.5 w-1.5">
                  <span className="bg-accent absolute inline-flex h-full w-full animate-ping rounded-full opacity-40" />
                  <span className="bg-accent relative inline-flex h-1.5 w-1.5 rounded-full" />
                </span>
                <span className="text-accent font-mono text-[11px] font-medium tabular-nums">
                  {formatNumber(total)}
                </span>
              </div>
            )}
          </div>

          <Button
            onClick={() => openEditor("create")}
            size="sm"
            variant="outline"
            className="border-accent/30 text-accent hover:bg-accent/10 hover:border-accent/50 h-8 shrink-0 gap-1.5 font-mono text-xs transition-colors sm:h-7"
            data-compact
          >
            <Plus className="h-3 w-3" />
            <span className="hidden sm:inline">new record</span>
          </Button>
        </div>
      </div>

      {/* ── Error ────────────────────────────────────── */}
      <InlineAlert message={error} className="mx-6 mt-3" />

      {/* ── Data Grid ────────────────────────────────── */}
      <div className="relative flex-1 overflow-auto">
        {!isDesktop && records.length > 0 ? (
          <>
            {/* Loading indicator (page navigation) */}
            {loading && (
              <div className="bg-accent/10 sticky top-0 right-0 left-0 z-20 h-[2px] overflow-hidden">
                <div className="loading-bar bg-accent h-full w-1/4 rounded-full" />
              </div>
            )}
            {/* Mobile card view */}
            <div className="space-y-2 p-3">
              {records.map((record, idx) => (
                <div
                  key={record.key.pk + idx}
                  className="border-border/40 bg-card/60 animate-fade-in rounded-lg border p-3"
                  style={{ animationDelay: `${idx * 25}ms` }}
                >
                  <div className="mb-2 flex items-center justify-between">
                    <div className="flex items-center gap-2">
                      <button
                        onClick={() => togglePK(String(record.key.pk))}
                        className={cn(
                          "inline-flex h-4 w-4 shrink-0 items-center justify-center rounded border transition-colors",
                          selectedPKs.has(String(record.key.pk))
                            ? "border-accent bg-accent text-accent-foreground"
                            : "border-muted-foreground/30 hover:border-muted-foreground/50",
                        )}
                      >
                        {selectedPKs.has(String(record.key.pk)) && <Check className="h-3 w-3" />}
                      </button>
                      <span className="text-accent font-mono text-sm font-medium">
                        {truncateMiddle(String(record.key.pk), 24)}
                      </span>
                    </div>
                    <div className="flex items-center gap-1">
                      <button
                        onClick={() => setViewRecord(record)}
                        className="text-muted-foreground hover:text-foreground hover:bg-muted/50 inline-flex h-9 w-9 items-center justify-center rounded-md transition-colors"
                      >
                        <Eye className="h-4 w-4" />
                      </button>
                      <button
                        onClick={() => openEditor("edit", record)}
                        className="text-muted-foreground hover:text-foreground hover:bg-muted/50 inline-flex h-9 w-9 items-center justify-center rounded-md transition-colors"
                      >
                        <Pencil className="h-4 w-4" />
                      </button>
                      <button
                        onClick={() => setDeleteTarget(record)}
                        className="text-muted-foreground hover:text-destructive hover:bg-destructive/10 inline-flex h-9 w-9 items-center justify-center rounded-md transition-colors"
                      >
                        <Trash2 className="h-4 w-4" />
                      </button>
                    </div>
                  </div>
                  <div className="flex gap-3 text-xs">
                    <span className="text-muted-foreground">
                      Gen:{" "}
                      <span className="text-foreground font-mono">{record.meta.generation}</span>
                    </span>
                    <span className="text-muted-foreground">
                      TTL:{" "}
                      <span className="text-foreground font-mono">
                        {record.meta.ttl === -1
                          ? "∞"
                          : record.meta.ttl === 0
                            ? "—"
                            : `${record.meta.ttl}s`}
                      </span>
                    </span>
                  </div>
                  {binColumns.length > 0 && (
                    <div className="border-border/30 mt-2 space-y-1 border-t pt-2">
                      {binColumns.slice(0, 3).map((col) => (
                        <div key={col} className="flex items-center gap-2 text-xs">
                          <span className="text-muted-foreground/60 w-20 shrink-0 truncate font-mono">
                            {col}
                          </span>
                          <span className="min-w-0 truncate">
                            {renderCellValue(record.bins[col])}
                          </span>
                        </div>
                      ))}
                      {binColumns.length > 3 && (
                        <span className="text-muted-foreground/50 text-[10px]">
                          +{binColumns.length - 3} more bins
                        </span>
                      )}
                    </div>
                  )}
                </div>
              ))}
            </div>
          </>
        ) : (
          <TooltipProvider delayDuration={300}>
            <DataTable
              data={records}
              columns={tableColumns}
              loading={loading}
              emptyState={
                <div className="flex flex-col items-center justify-center py-20 text-center">
                  <Database className="text-muted-foreground/30 mb-4 h-16 w-16" />
                  <h3 className="text-base-content/70 mb-2 text-lg font-semibold">
                    No Records Found
                  </h3>
                  <p className="text-base-content/50 mb-6 max-w-md text-sm">
                    This set appears to be empty. Create a new record to get started.
                  </p>
                  <button
                    className="btn btn-primary btn-sm gap-2"
                    onClick={() => openEditor("create")}
                  >
                    <Plus className="h-4 w-4" />
                    Create Record
                  </button>
                </div>
              }
              enableColumnPinning
              columnPinning={COLUMN_PINNING}
              onRowClick={(row) => setViewRecord(row.original)}
              tableMinWidth={tableMinWidth}
              testId="records-table"
            />
          </TooltipProvider>
        )}
      </div>

      {/* ── Selection Toolbar ─────────────────────────── */}
      {selectedPKs.size > 0 && (
        <div className="border-accent/30 bg-accent/5 border-t px-3 py-2 backdrop-blur-md sm:px-6">
          <div className="flex items-center justify-between gap-2">
            <div className="flex items-center gap-3">
              <span className="text-accent font-mono text-[11px] font-medium tabular-nums">
                {selectedPKs.size} selected
              </span>
              <button
                onClick={() => setSelectedPKs(new Set())}
                className="text-muted-foreground hover:text-foreground inline-flex items-center gap-1 font-mono text-[11px] transition-colors"
              >
                <X className="h-3 w-3" />
                Clear
              </button>
            </div>
            <Button
              onClick={() => setBatchDialogOpen(true)}
              size="sm"
              variant="outline"
              className="border-accent/30 text-accent hover:bg-accent/10 hover:border-accent/50 h-7 gap-1.5 font-mono text-xs transition-colors"
              data-compact
            >
              <Code className="h-3 w-3" />
              Generate batch_read
            </Button>
          </div>
        </div>
      )}

      {/* ── Status Bar ───────────────────────────────── */}
      <TablePagination
        total={total}
        page={page}
        pageSize={pageSize}
        onPageChange={handlePageChange}
        onPageSizeChange={handlePageSizeChange}
        loading={loading}
        pageSizeOptions={PAGE_SIZE_OPTIONS}
      />

      <RecordViewDialog record={viewRecord} onClose={() => setViewRecord(null)} />

      <RecordEditorDialog
        open={editorOpen}
        onOpenChange={setEditorOpen}
        mode={editorMode}
        namespace={decodedNs}
        set={decodedSet}
        pk={editorPK}
        onPKChange={setEditorPK}
        ttl={editorTTL}
        onTTLChange={setEditorTTL}
        bins={editorBins}
        onAddBin={addBin}
        onRemoveBin={removeBin}
        onUpdateBin={updateBin}
        useCodeEditor={useCodeEditor}
        onToggleCodeEditor={(id) => setUseCodeEditor((prev) => ({ ...prev, [id]: !prev[id] }))}
        saving={saving}
        onSave={handleSaveRecord}
      />

      <BatchReadDialog
        open={batchDialogOpen}
        onOpenChange={setBatchDialogOpen}
        selectedCount={selectedPKs.size}
        generateCode={generateBatchReadCode}
      />

      {/* ── Delete Confirmation ──────────────────────── */}
      <ConfirmDialog
        open={!!deleteTarget}
        onOpenChange={(open) => !open && setDeleteTarget(null)}
        title="Delete Record"
        description={`Are you sure you want to delete record with PK "${deleteTarget?.key.pk}"? This cannot be undone.`}
        confirmLabel="Delete"
        variant="destructive"
        onConfirm={handleDeleteRecord}
        loading={deleting}
      />
    </div>
  );
}
